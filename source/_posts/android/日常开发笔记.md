---
title: æ—¥å¸¸å¼€å‘ç¬”è®°
date: 2018-01-23 21:30:50
updated: 2018-01-23 21:30:50
tags: [android, note]
categories: android
---


# æ—¥å¸¸å¼€å‘ç¬”è®°


### Space ä½¿ç”¨åœºæ™¯
Space æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºè§†å›¾ä¹‹é—´ç©ºéš™çš„è½»é‡çº§Viewï¼Œå†onDraw()ä¸­ä¸æ‰§è¡Œä»»ä½•ç»˜åˆ¶ï¼Œæ‰€ä»¥`android:background` å±æ€§å¯¹å®ƒä¸èµ·ä½œç”¨ã€‚

é€šå¸¸åœ¨åˆ›å»ºè§†å›¾ç©ºéš™çš„æ—¶å€™ï¼Œ**åœ¨ä¸è€ƒè™‘èƒŒæ™¯è‰²çš„æƒ…å†µä¸‹ï¼ŒSpaceæ•ˆç‡æ›´é«˜**ã€‚

> æ³¨æ„ï¼šç”±äºæ§ä»¶æ˜¯ API 14 å¼•å…¥ï¼Œå¦‚è¦å‘ä¸‹å…¼å®¹ï¼Œéœ€è¦ä½¿ç”¨**v4.widget.Space**



### è‡ªåŠ¨è°ƒç”¨Viewç‚¹å‡»äº‹ä»¶ï¼Œæ¨¡æ‹Ÿç”¨æˆ·ç‚¹å‡»è¡Œä¸º

```java
view.performClick();
view.performLongClick();
```



### ç³»ç»Ÿå†…ç½®æ–¹æ³•/å·¥å…·

#### DateUtils
`DateUtils.formayDateTime()`ä»£æ›¿JDKä¸­çš„`new SimpleDateFormat("yyy-MM-dd HH:mm").format()`ã€‚
å‡ ä¸ªå¸¸ç”¨çš„formatæ ¼å¼ï¼š
- FORMAT_SHOW_DATEï¼š3æœˆ3æ—¥
- FORMAT_SHOW_TIMEï¼š10:37
- FORMAT_SHOW_WEEKDAYï¼šæ˜ŸæœŸäº”
- FORMAT_SHOW_YEARï¼š2017å¹´3æœˆ3æ—¥
- FORMAT_NUMERIC_DATEï¼š3/3
- FORMAT_NO_MONTH_DAYï¼šä¸‰æœˆ



#### TextUtils

`TextUtils.isEmpty(CharSequence str)`



#### Log

`Log.getStackTraceString(Throwable tr)`å¯ä»¥ä»Throwableå¯¹è±¡ä¸­è·å–é”™è¯¯ä¿¡æ¯ï¼Œå¹¶ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›ã€‚å½“ä½ éœ€è¦é”™è¯¯ä¿¡æ¯çš„æ•°æ®æŒä¹…åŒ–æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆæ–¹ä¾¿ã€‚
ä½¿ç”¨åœºæ™¯ï¼šä¿å­˜è‡³æœ¬åœ°å­˜å‚¨å¡æˆ–ä¸Šä¼ æœåŠ¡å™¨ã€‚



### 5ä¸ªå¸¸è§çš„å†…å­˜æ³„éœ²çš„é—®é¢˜

å†…å­˜æ³„éœ²æ—¶é€ æˆOOMçš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚ç”±äºAndroidç³»ç»Ÿä¸ºæ¯ä¸ªåº”ç”¨ç¨‹åºåˆ†é…çš„å†…å­˜æœ‰é™ï¼Œå½“ä¸€ä¸ªåº”ç”¨ä¸­äº§ç”Ÿå†…å­˜æ³„éœ²è¾ƒå¤šæ—¶ï¼Œå°±å—åç°å¯¼è‡´åº”ç”¨æ‰€éœ€è¦çš„å†…å­˜è¶…è¿‡åˆ†é…çš„é™é¢ï¼Œè¿™å°±å¯¼è‡´åº”ç”¨Crashã€‚



#### 1. å•ä¾‹é€ æˆçš„å†…å­˜æ³„éœ²

ç”±äºå•ä¾‹çš„é™æ€ç‰¹æ€§ä½¿å¾—å•ä¾‹çš„ç”Ÿå‘½å‘¨æœŸå’Œåº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸€æ ·é•¿ï¼Œä¹Ÿå°±è¯´æ˜å¦‚æœä¸€ä¸ªå¯¹è±¡å·²ç»ä¸éœ€è¦ä½¿ç”¨çš„æ—¶å€™ï¼Œè€Œå•ä¾‹å¯¹è±¡è¿˜æŒæœ‰è¯¥å¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°†ä¸èƒ½è¢«æ­£å¸¸å›æ”¶ï¼Œè¿™å°±å¯¼è‡´äº†å†…å­˜æ³„éœ²ã€‚
ä¸¾ä¾‹ï¼š
```java
//worng
public class AppManager {
    private static AppManager instance;
    private Context context;
    private AppManager(Context context) {
        this.context = context;
    }
    public static AppManager getInstance(Context context) {
        if (instance != null) {
            instance = new AppManager(context);
        }
        return instance;
    }
}
//right
public class AppManager {
    private static AppManager instance;
    private Context context;
    private AppManager(Context context) {
        this.context = context.getApplicationContext();
    }
    public static AppManager getInstance(Context context) {
        if (instance != null) {
            instance = new AppManager(context);
        }
        return instance;
    }
}
```
#### 2. éé™æ€å†…éƒ¨ç±»åˆ›å»ºé™æ€å®ä¾‹é€ æˆçš„å†…å­˜æ³„éœ²


#### 2.1 Handleré€ æˆçš„å†…å­˜æ³„éœ²
Handleræ­£ç¡®çš„ä½¿ç”¨æ–¹å¼ï¼š
```java
private MyHandler mHandler = new MyHandler(this);
private static class MyHandler extends Handler {
        private WeakReference<Context> reference;
        public MyHandler(Context context) {
            reference = new WeakReference<>(context);
        }
        @Override
        public void handleMessage(Message msg) {
            Activity activity = (Activity) reference.get();
            if(activity != null){
                //do something
                //...
            }
        }
    }
    
    @Override
    protected void onDestroy() {
      super.onDestroy();
      mHandler.removeCallbackAndMessage(null);
    }
```
#### 3. éé™æ€å†…éƒ¨ç±»

#### 3.1 çº¿ç¨‹é€ æˆçš„å†…å­˜æ³„éœ²
```java
//test1
new AsyncTask<Void, Void, Void>() {
            @Override
            protected Void doInBackground(Void... params) {
                SystemClock.sleep(10000);
                return null;
            }
        }.execute();
        
//test2
new Thread(new Runnable() {
            @Override
            public void run() {
                SystemClock.sleep(10000);
            }
        }).start();
```
ä¸Šé¢çš„ä¸€éƒ¨ä»»åŠ¡å’ŒRunnableéƒ½æ˜¯ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»ï¼Œå› æ­¤å®ƒä»¬å¯¹å½“å‰Activityéƒ½æœ‰ä¸€ä¸ªéšå£«å¼•ç”¨ã€‚
å¦‚æœActivityåœ¨é”€æ¯ä¹‹å‰ï¼Œä»»åŠ¡è¿˜æ²¡å®Œæˆï¼Œé‚£ä¹ˆå¯¼è‡´Activityçš„å†…å­˜èµ„æºæ— æ³•å›æ”¶ï¼Œé€ æˆå†…å­˜æ³„éœ²ã€‚
æ­£ç¡®çš„åšæ³•ï¼Œåº”è¯¥ä½¿ç”¨é™æ€å†…éƒ¨ç±»çš„æ–¹å¼å®ç°ï¼Œå¦‚ä¸‹ï¼š
```java
static class MyAsyncTask extends AsyncTask<Void, Void, Void> {
        private WeakReference<Context> weakReference;
  
        public MyAsyncTask(Context context) {
            weakReference = new WeakReference<>(context);
        }
  
        @Override
        protected Void doInBackground(Void... params) {
            SystemClock.sleep(10000);
            return null;
        }
  
        @Override
        protected void onPostExecute(Void aVoid) {
            super.onPostExecute(aVoid);
            MainActivity activity = (MainActivity) weakReference.get();
            if (activity != null) {
                //...
            }
        }
    }
    static class MyRunnable implements Runnable{
        @Override
        public void run() {
            SystemClock.sleep(10000);
        }
    }
    
    //-------
    new Thread(new MyRunnable()).start();
    new MyAsyncTask(this).execute();
```
è¿™æ ·å°±é¿å…äº†Activityçš„å†…å­˜èµ„æºæ³„éœ²ï¼Œå½“ç„¶åœ¨Activityé”€æ¯æ—¶ä¹Ÿåº”è¯¥å–æ¶ˆç›¸åº”çš„ä»»åŠ¡`AsyncTask.cancel()`ï¼Œé¿å…ä»»åŠ¡åœ¨åå°æ‰§è¡Œæµªè´¹çš„èµ„æºã€‚

#### 4. èµ„æºæœªå…³é—­é€ æˆçš„å†…å­˜æ³„éœ²
å¯¹äºBroadcastReceiverã€Fileã€Streamã€ Cursorã€Bitmap ç­‰èµ„æºçš„ä½¿ç”¨ï¼Œåº”è¯¥åœ¨Activityé”€æ¯æ—¶åŠæ—¶å…³é—­æˆ–è€…æ³¨é”€ï¼Œå¦åˆ™è¿™äº›èµ„æºå°†ä¸ä¼šè¢«å›æ”¶ï¼Œé€ æˆå†…å­˜æ³„éœ²ã€‚

### èµ„æºç›¸å…³

#### string.xml 
`<b></b>` åŠ ç²—å­—ä½“
`<i></i>` æ–œä½“å­—ä½“
`<u></u> `ç»™å­—ä½“åŠ ä¸‹åˆ’çº¿
`\n` æ¢è¡Œ
`\u0020` è¡¨ç¤ºç©ºæ ¼
`\u2026` è¡¨ç¤ºçœç•¥å·


####SpannableString ä¸ SpannableStringBuilder
ç±»ä¼¼äºStringå’ŒStringBuilder
SpannableString é•¿åº¦ä¸å¯å˜
SpannableStringBuilder é•¿åº¦å¯å˜

#### `@`å’Œ`?`ä¹‹é—´çš„åŒºåˆ«
@ æ ‡è®°æ˜¯å¼•ç”¨ä¸€ä¸ªå®é™…çš„å€¼ï¼ˆcolor, string, dimension...ï¼‰ã€‚
? æ ‡è®°æ˜¯å¼•ç”¨ä¸€ä¸ª`style attribute`ï¼Œå…¶å€¼å–å†³äºå½“å‰ä½¿ç”¨çš„ä¸»é¢˜ã€‚

#### InputFilter
`EditText.maxLength` åœ¨ä½¿ç”¨InputFilter ä¹‹åä¼šå¤±æ•ˆ

#### ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨ï¼Ÿ
çº¿ç¨‹å®‰å…¨æ˜¯æŒ‡å¤šçº¿ç¨‹è®¿é—®ç»Ÿä¸€ä»£ç ï¼Œä¸ä¼šäº§ç”Ÿä¸ç¡®å®šçš„ç»“æœã€‚

#### view.post
viewè·å–åˆ°å…³è”çº¿ç¨‹ï¼ˆå³UIçº¿ç¨‹ï¼Œå› ä¸ºåªæœ‰UIçº¿ç¨‹æ‰èƒ½åˆ›å»ºviewï¼‰çš„handlerï¼Œç„¶åè°ƒç”¨è¯¥handlerçš„postæ–¹æ³•ï¼Œå³æŠŠè¿™ä¸ªä»»åŠ¡å°è£…æˆä¸€ä¸ªæ¶ˆæ¯poståˆ°ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åç­‰å¾…æ‰§è¡Œã€‚

#### ä»£ç æ··æ·†
1. å¼€å¯ä»£ç æ··æ·†
```
buildTypes {
  release {
    minifyEnabled false
    proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-reles.pro'
  }
}
```

2. æ·»åŠ æ··æ·†è§„åˆ™
```
-dontskipnonpubliclibraryclasses # ä¸å¿½ç•¥éå…¬å…±çš„åº“ç±»
-optimizationpasses 5 # æŒ‡å®šä»£ç çš„å‹ç¼©çº§åˆ«
-dontusemixedcaseclassnames # æ˜¯å¦ä½¿ç”¨å¤§å°å†™æ··åˆ
-dontpreverify # æ··æ·†æ—¶æ˜¯å¦åšé¢„æ ¡éªŒ
-verbose # æ··æ·†æ—¶æ˜¯å¦è®°å½•æ—¥å¿—
-keepattributes *Annotation* # ä¿æŒæ³¨è§£
-ignorewarning # å¿½ç•¥è­¦å‘Š
-dontoptimize # ä¼˜åŒ–ä¸ä¼˜åŒ–è¾“å…¥çš„ç±»æ–‡ä»¶

-optimizations !code/simplification/arithmetic,!field/*,!class/merging/* # æ··æ·†æ—¶æ‰€é‡‡ç”¨çš„ç®—æ³•

#ä¿æŒå“ªäº›ç±»ä¸è¢«æ··æ·†
-keep public class * extends android.app.Activity
-keep public class * extends android.app.Application
-keep public class * extends android.app.Service
-keep public class * extends android.content.BroadcastReceiver
-keep public class * extends android.content.ContentProvider
-keep public class * extends android.app.backup.BackupAgentHelper
-keep public class * extends android.preference.Preference
-keep public class com.android.vending.licensing.ILicensingService

#ç”Ÿæˆæ—¥å¿—æ•°æ®ï¼Œgradle buildæ—¶åœ¨æœ¬é¡¹ç›®æ ¹ç›®å½•è¾“å‡º
-dump class_files.txt #apkåŒ…å†…æ‰€æœ‰classçš„å†…éƒ¨ç»“æ„
-printseeds seeds.txt #æœªæ··æ·†çš„ç±»å’Œæˆå‘˜
-printusage unused.txt #æ‰“å°æœªè¢«ä½¿ç”¨çš„ä»£ç 
-printmapping mapping.txt #æ··æ·†å‰åçš„æ˜ å°„

-keep public class * extends android.support.** #å¦‚æœæœ‰å¼•ç”¨v4æˆ–è€…v7åŒ…ï¼Œéœ€æ·»åŠ 
-libraryjars libs/xxx.jar #æ··æ·†ç¬¬ä¸‰æ–¹jaråŒ…ï¼Œå…¶ä¸­xxxä¸ºjaråŒ…å
-keep class com.xxx.**{*;} #ä¸æ··æ·†æŸä¸ªåŒ…å†…çš„æ‰€æœ‰æ–‡ä»¶
-dontwarn com.xxx** #å¿½ç•¥æŸä¸ªåŒ…çš„è­¦å‘Š
-keepattributes Signature #ä¸æ··æ·†æ³›å‹
-keepnames class * implements java.io.Serializable #ä¸æ··æ·†Serializable

-keepclassmembers class **.R$* { #ä¸æ··æ·†èµ„æºç±»
public static <fields>;
}
-keepclasseswithmembernames class * { # ä¿æŒ native æ–¹æ³•ä¸è¢«æ··æ·†
native <methods>;
}
-keepclasseswithmembers class * { # ä¿æŒè‡ªå®šä¹‰æ§ä»¶ç±»ä¸è¢«æ··æ·†
public <init>(android.content.Context, android.util.AttributeSet);
}
-keepclasseswithmembers class * { # ä¿æŒè‡ªå®šä¹‰æ§ä»¶ç±»ä¸è¢«æ··æ·†
public <init>(android.content.Context, android.util.AttributeSet, int);
}
-keepclassmembers class * extends android.app.Activity { # ä¿æŒè‡ªå®šä¹‰æ§ä»¶ç±»ä¸è¢«æ··æ·†
public void *(android.view.View);
}
-keepclassmembers enum * { # ä¿æŒæšä¸¾ enum ç±»ä¸è¢«æ··æ·†
public static **[] values();
public static ** valueOf(java.lang.String);
}
-keep class * implements android.os.Parcelable { # ä¿æŒ Parcelable ä¸è¢«æ··æ·†
public static final android.os.Parcelable$Creator *;
}
```

### PopupWindow å’Œ Dialogçš„åŒºåˆ«
**ä¸åŒç‚¹**
2. Popupwindowåœ¨æ˜¾ç¤ºä¹‹å‰ä¸€å®šè¦è®¾ç½®å®½é«˜ï¼ŒDialogæ— æ­¤é™åˆ¶ã€‚
3. Popupwindowé»˜è®¤ä¸ä¼šå“åº”ç‰©ç†é”®ç›˜çš„backï¼Œé™¤éæ˜¾ç¤ºè®¾ç½®äº†popup.setFocusable(true)ï¼›è€Œåœ¨ç‚¹å‡»backçš„æ—¶å€™ï¼ŒDialogä¼šæ¶ˆå¤±ã€‚
4. Popupwindowä¸ä¼šç»™é¡µé¢å…¶ä»–çš„éƒ¨åˆ†æ·»åŠ è’™å±‚ï¼Œè€ŒDialogä¼šã€‚
5. Popupwindowæ²¡æœ‰æ ‡é¢˜ï¼ŒDialogé»˜è®¤æœ‰æ ‡é¢˜ï¼Œå¯ä»¥é€šè¿‡`dialog.requestWindowFeature(Window.FEATURE_NO_TITLE);`å–æ¶ˆæ ‡é¢˜

AlertDialogæ˜¯**éé˜»å¡å¼**å¯¹è¯æ¡†ï¼ŒAlertDialogå¼¹å‡ºæ—¶ï¼Œåå°è¿˜å¯ä»¥åšå…¶ä»–äº‹æƒ…ï¼›è€ŒPopupWindowæ˜¯**é˜»å¡å¼**å¯¹è¯æ¡†ï¼ŒPopupWindowå¼¹å‡ºç›´è‡³PopupWindowæ¨å‡ºå‰ï¼Œç¨‹åºä¼šä¸€ç›´ç­‰å¾…ï¼Œç­‰å¾…dismissæ–¹å¼æ‰§è¡Œåï¼Œç¨‹åºæ‰ä¼šæƒ³ä¸‹æ‰§è¡Œã€‚
è¿™ä¸¤ç§åŒºåˆ«çš„è¡¨ç°æ˜¯ï¼š

**å…±åŒç‚¹**
1. äºŒè€…æ˜¾ç¤ºçš„æ—¶å€™éƒ½è¦è®¾ç½®Gravityï¼Œå¦‚ä¸è®¾ç½®ï¼ŒDialogé»˜è®¤æ˜¯Gravity.CENTER
2. äºŒè€…éƒ½æœ‰é»˜è®¤çš„èƒŒæ™¯ï¼Œéƒ½å¯ä»¥é€šè¿‡`setBackgroundDrawable(new ColorDrawable(android.R.color.transparent));`å»æ‰ã€‚

### æ·±å…¥ç†è§£ fitsSystemWindows
é€æ˜çŠ¶æ€æ æ˜¯ Android apps ä¸­ç»å¸¸éœ€è¦å®ç°çš„ä¸€ç§æ•ˆæœï¼Œå¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œå¼€å‘è€…éƒ½è¦ä¸ºä¸åŒç‰ˆæœ¬çš„é€‚é…è€Œå¤´ç—›ï¼Œè‡ª Android 4.4 KitKat ä»¥æ¥ï¼Œç³»ç»Ÿä¸­å°±å·²ç»æä¾›ä¿®æ”¹çŠ¶æ€æ ï¼ˆSystemUIï¼‰æ˜¾ç¤ºè¡Œä¸ºçš„é€‰é¡¹äº†ã€‚å…¶ä¸­å¸¦æ¥çš„ä¸€ä¸ªæœ€ä»¤äººå›°æƒ‘çš„é—®é¢˜å°±æ˜¯ `fitsSystemWindows` è¿™ä¸ªå±æ€§ç©¶ç«Ÿè¯¥å¦‚ä½•ä½¿ç”¨ã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œç»™ Activity è®¾ç½®é€æ˜çŠ¶æ€æ ååˆ†ç®€å•ï¼Œä½¿ç”¨ä¸‹é¢çš„ code snippet å°±å¯ä»¥äº†ï¼š
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
    Window window = getWindow();
    window.clearFlags(WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS);
    window.addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
    window.getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
            | View.SYSTEM_UI_FLAG_LAYOUT_STABLE);
    window.setStatusBarColor(Color.TRANSPARENT);
}
```
å®ƒç›¸è¾ƒäºç›´æ¥åœ¨ style.xml ä¸­å®šä¹‰æ ·å¼çš„å¥½å¤„å°±æ˜¯ä¸ä¼šæœ‰ä¸€ä¸ª scrimï¼ˆä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘å¥½ï¼Œå°±æ˜¯é‚£ä¸ªåŠé€æ˜çš„é®ç½©ï¼‰ã€‚ä½†åªåšè¿™ä¸ªå·¥ä½œå°±ä¼šå¯¼è‡´ä¸‹é¢è¿™ä¸ªæƒ…å†µï¼š
<br>
<br>
![Figure 1.](/res/android/1.png)
<br>
<br>
å†…å®¹ä¸çŠ¶æ€æ åŒºåŸŸé‡å äº†ï¼é€šå¸¸ï¼Œå¤§å¤šæ•°äººä¼šåœ¨å¸ƒå±€ä¸­åŠ ä¸€ä¸ªï¼š
```xml
android:fitsSystemWindows="true"
```
ç„¶åçŠ¶æ€æ å°±æ˜¾ç¤ºæ­£å¸¸äº†ï¼Œä½†è¿™è¿˜å–å†³äºå¸ƒå±€ï¼Œæœ‰çš„å¸ƒå±€ç±»ç›´æ¥åŠ è¿™ä¸ªå±æ€§å¯èƒ½å°±ä¸ workï¼Œå°¤å…¶æ˜¯ `CoordinatorLayout` ç›¸å…³çš„å¸ƒå±€ï¼Œè®©äººæ„Ÿè§‰è¿™ä¸ªå±æ€§å¾ˆè¿·ã€‚ç¡®å®ï¼Œæ²¡æœ‰åˆ†ææºç çš„æ—¶å€™æˆ‘ä¹Ÿå¾ˆå›°æƒ‘ã€‚ä½†ç»è¿‡ç®€å•çš„åˆ†æï¼Œä¸€åˆ‡éƒ½ä¸æ˜¯ç§˜å¯†ã€‚

#### åˆæ­¥åˆ†æ

é¦–å…ˆè¦æƒ³ææ¸…æ¥šè¿™ä¸ªå±æ€§çš„ä½œç”¨ï¼Œæˆ‘ä»¬å°±è¦åˆ°ç±»ä¸­çœ‹çœ‹è®¾ç½®ç›¸å…³å±æ€§ååˆ°åº•ä¼šå‘ç”Ÿä»€ä¹ˆå˜åŒ–ï¼Œäºæ˜¯æ‰¾åˆ° View ç±»çš„ `setFitsSystemWindows` æ–¹æ³•ï¼š
```java
public void setFitsSystemWindows(boolean fitSystemWindows) {
    setFlags(fitSystemWindows ? FITS_SYSTEM_WINDOWS : 0, FITS_SYSTEM_WINDOWS);
}
```
é¢ï¼Œå¥½å§ï¼Œå…¶å®ç»è¿‡ç»§ç»­è·Ÿè¸ªä¹‹åï¼Œæ”¹å˜è¿™ä¸ª flag æ ¹æœ¬ä¸ä¼šé€ æˆ View çš„é‡æ–°å¸ƒå±€å’Œ invalidateï¼Œæ‰€ä»¥è¿™ä¸ªå±æ€§ä¸€å®šæ˜¯è¦åœ¨å¸ƒå±€å‘ç”Ÿä¹‹å‰è®¾ç½®å¥½çš„ã€‚ä½†æ˜¯çœ‹æ–¹æ³•æ–‡æ¡£å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªå±æ€§ä¸ä¸€ä¸ªåä¸º `fitSystemWindows` çš„æ–¹æ³•å¯†åˆ‡ç›¸å…³ï¼Œçœ‹ä¸€ä¸‹ï¼š
```java
protected boolean fitSystemWindows(Rect insets) {
    if ((mPrivateFlags3 & PFLAG3_APPLYING_INSETS) == 0) {
        if (insets == null) {
            // Null insets by definition have already been consumed.
            // This call cannot apply insets since there are none to apply,
            // so return false.
            return false;
        }
        // If we're not in the process of dispatching the newer apply insets call,
        // that means we're not in the compatibility path. Dispatch into the newer
        // apply insets path and take things from there.
        try {
            mPrivateFlags3 |= PFLAG3_FITTING_SYSTEM_WINDOWS;
            return dispatchApplyWindowInsets(new WindowInsets(insets)).isConsumed();
        } finally {
            mPrivateFlags3 &= ~PFLAG3_FITTING_SYSTEM_WINDOWS;
        }
    } else {
        // We're being called from the newer apply insets path.
        // Perform the standard fallback behavior.
        return fitSystemWindowsInt(insets);
    }
}
```
è¿™é‡Œé¢æ¶‰åŠä¸€ä¸ªè½¬å‘ä¿®æ­£çš„é—®é¢˜ï¼Œæˆ‘ä»¬è¿™é‡Œå…ˆä¸å»ç®¡å®ƒï¼Œç›´æ¥çœ‹çœŸæ­£çš„å®ç°`fitSystemWindowsInt`ï¼š
```java
private boolean fitSystemWindowsInt(Rect insets) {
    if ((mViewFlags & FITS_SYSTEM_WINDOWS) == FITS_SYSTEM_WINDOWS) {
        mUserPaddingStart = UNDEFINED_PADDING;
        mUserPaddingEnd = UNDEFINED_PADDING;
        Rect localInsets = sThreadLocal.get();
        if (localInsets == null) {
            localInsets = new Rect();
            sThreadLocal.set(localInsets);
        }
        boolean res = computeFitSystemWindows(insets, localInsets);
        mUserPaddingLeftInitial = localInsets.left;
        mUserPaddingRightInitial = localInsets.right;
        internalSetPadding(localInsets.left, localInsets.top,
                localInsets.right, localInsets.bottom);
        return res;
    }
    return false;
}
```
å¯ä»¥çœ‹åˆ°ï¼Œ`fitsSystemWindows` è¿™ä¸ªå±æ€§åœ¨è¿™å‘æŒ¥äº†ç”¨æ­¦ä¹‹åœ°ï¼Œå¦‚æœè®¾ç½®äº†è¿™ä¸ªå±æ€§ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰ä¸€ä¸ª padding çš„è®¾ç½®ï¼Œé‚£è¿™ä¸ª padding æ¥è‡ªå“ªï¼Œå®ƒæ˜¯ä»€ä¹ˆï¼Œç°åœ¨è¿˜ä¸å¾—è€ŒçŸ¥ï¼Œè¿™é‡Œå°±é¢„è®¡æ˜¯çŠ¶æ€æ çš„åŒºåŸŸå§ã€‚padding æœ‰ä»€ä¹ˆç”¨å‘¢ï¼ŒViewGroup çš„ä¸€äº›å­ç±»åœ¨ measure å’Œ layout çš„æ—¶å€™ä¼šè·å– super ä¸­ä¸ padding ç›¸å…³çš„æˆå‘˜å˜é‡æ¥åšå¸ƒå±€ä¸Šçš„è°ƒæ•´ï¼Œè¿™å°±å¯ä»¥å®ç°é¿å¼€çŠ¶æ€æ çš„é—®é¢˜äº†ã€‚

ä½†æ˜¯ï¼Œä¸Šè¿°æ–¹æ³•çš„è°ƒç”¨æ—¶æœºç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ—¶å€™å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ IDE ä¸­å¼ºå¤§çš„ **Find Usages** æ¥åå‘æ¨å¯¼ä¸€ä¸‹ã€‚æœ€åå‘ç°å®ƒæ˜¯ç”±ä¸€ä¸ªåä¸º `dispatchApplyWindowInsets` çš„æ–¹æ³•è°ƒç”¨çš„ï¼Œè€Œä¸”é€šè¿‡å‚æ•°ä¼ äº†ä¸€ä¸ª `WindowInsets` å¯¹è±¡ï¼Œè¿™æ˜¯ä»€ä¹ˆé¬¼ï¼Œæˆ‘ä»¬åé¢å°±ä¼šè®²åˆ°ã€‚åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬æ–­ç‚¹æ‰“ä¸€ä¸‹ï¼Œçœ‹çœ‹è¿™ä¸ªæ–¹æ³•æ˜¯æ€ä¹ˆè¢«è°ƒç”¨èµ·æ¥çš„ï¼š
<br>
<br>
![Figure 2.](res/android/2.png)
<br>
<br>
åŸæ¥æ˜¯ `ViewRootImpl` å‘èµ·çš„ï¼Œè¿™ä¸ªç±»å¾ˆé‡è¦ï¼Œå®ç°äº†å¾ˆå¤š View ä¸ **WindowManager** çš„äº¤äº’ï¼Œè¿™é‡Œ `ViewRootImpl` somehow æ‹¿åˆ°äº†ä¸€ä¸ª `WindowInsets` å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¤§å®¶å¯ä»¥çœ‹çœ‹æ–‡æ¡£ï¼Œå°±æ˜¯åŒ…å«äº†ä¸€äº›ç³»ç»Ÿæ‰€å ç”¨çš„åŒºåŸŸï¼Œ**è¿™äº›åŒºåŸŸå¯ä»¥è¢«æ¶ˆè€—æ‰ï¼Œå¹¶ä¸”æ¶ˆè€—ä¹‹åè¿”å›çš„æ˜¯ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼Œè¿™å¥è¯è¯·è°¨è®°**ã€‚

æœ‰å…³çŠ¶æ€æ çš„é«˜åº¦åŒ…å«åœ¨è¿™ä¸ªå¯¹è±¡ä¸­æ— ç–‘äº†ï¼Œä¸ºäº†æ—¥åçš„æ‰©å±•æ€§ï¼Œè¿™ä¸ªå¯¹è±¡å¯èƒ½è¿˜ä¼šæ–°å¢æ›´å¤šçš„ insets ç±»å‹ï¼Œä½†å°±ç›®å‰è€Œè¨€ï¼Œä»…é™äºçŠ¶æ€æ å’Œåœ†å½¢æ‰‹è¡¨ä¸Šçš„ä¸€äº›ç‰¹æ®Šæ¨¡å¼ã€‚

å¥½ï¼Œæˆ‘ä»¬ç»§ç»­åˆ†æä¸Šé¢æåˆ°çš„é‚£ä¸ªæ–¹æ³•ï¼š
```java
public WindowInsets dispatchApplyWindowInsets(WindowInsets insets) {
    try {
        mPrivateFlags3 |= PFLAG3_APPLYING_INSETS;
        if (mListenerInfo != null && mListenerInfo.mOnApplyWindowInsetsListener != null) {
            return mListenerInfo.mOnApplyWindowInsetsListener.onApplyWindowInsets(this, insets);
        } else {
            return onApplyWindowInsets(insets);
        }
    } finally {
        mPrivateFlags3 &= ~PFLAG3_APPLYING_INSETS;
    }
}
```
å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä¸ç®¡è®¾æ²¡è®¾ç½® `fitsSystemWindows` å±æ€§ï¼Œéƒ½ä¼šæ¿€å‘ä¸€ä¸ª `onApplyWindowInsets` å›è°ƒï¼Œå¹¶ä¸”è¿™ä¸ªå›è°ƒè¿˜å¯ä»¥é€šè¿‡ Listener è®¾ç½®ï¼Œæœ‰ç‚¹æ„æ€ã€‚å½“ç„¶äº†ï¼Œé»˜è®¤çš„å›è°ƒå®ç°çš„åŠŸèƒ½ä¸Šé¢å·²ç»åˆ†æè¿‡äº†ã€‚

åˆ°ç°åœ¨ä¸ºæ­¢è²Œä¼¼å°±å¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆè®¾ç½® `fitsSystemWindows` å±æ€§åï¼Œç»å¤§éƒ¨åˆ†å¸ƒå±€å°±å¯ä»¥é¿å¼€çŠ¶æ€æ äº†ã€‚ä½†æ˜¯ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å‘ç° `CoordinatorLayout` ä¼šåœ¨çŠ¶æ€æ ä¸‹é¢ç”»ä¸€ä¸ªåº•è‰²ï¼Ÿ`FrameLayout` å°±æ²¡æœ‰è¿™ä¸ªç‰¹æŠ€ï¼Œçœ‹æ¥ `CoordinatorLayout` çš„å¤„ç†æ–¹å¼å¹¶éä¸€ä¸ªç®€å•çš„ paddingï¼Œè‚¯å®šæœ‰è‡ªå·±çš„å®ç°é€»è¾‘ã€‚

æˆ‘ä»¬å»å®ƒçš„æºç æ‰¾æ‰¾çœ‹ï¼š
```java
@Override
    public void setFitsSystemWindows(boolean fitSystemWindows) {
    super.setFitsSystemWindows(fitSystemWindows);
    setupForInsets();
}
```
ç›´å¥” `setupForInsets`ï¼š
```java
private void setupForInsets() {
    if (Build.VERSION.SDK_INT < 21) {
        return;
    }

    if (ViewCompat.getFitsSystemWindows(this)) {
        if (mApplyWindowInsetsListener == null) {
            mApplyWindowInsetsListener =
                    new android.support.v4.view.OnApplyWindowInsetsListener() {
                        @Override
                        public WindowInsetsCompat onApplyWindowInsets(View v,
                                WindowInsetsCompat insets) {
                            return setWindowInsets(insets);
                        }
                    };
        }
        // First apply the insets listener
        ViewCompat.setOnApplyWindowInsetsListener(this, mApplyWindowInsetsListener);

        // Now set the sys ui flags to enable us to lay out in the window insets
        setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_STABLE
                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN);
    } else {
        ViewCompat.setOnApplyWindowInsetsListener(this, null);
    }
}
```
è¿™æ®µä»£ç å¯ä»¥è¯´å°±æ˜¯ View éœ€è¦è‡ªå®šä¹‰ `fitsSystemWindows` è¡Œä¸ºçš„æ ‡å‡†èŒƒå¼ã€‚æ ¸å¿ƒçš„å¤„ç†é€»è¾‘å°±åœ¨ `setWindowInsets` è¿™ä¸ªæ–¹æ³•ä¸­ï¼š
```java
final WindowInsetsCompat setWindowInsets(WindowInsetsCompat insets) {
    if (!objectEquals(mLastInsets, insets)) {
        mLastInsets = insets;
        mDrawStatusBarBackground = insets != null && insets.getSystemWindowInsetTop() > 0;
        setWillNotDraw(!mDrawStatusBarBackground && getBackground() == null);

        // Now dispatch to the Behaviors
        insets = dispatchApplyWindowInsetsToBehaviors(insets);
        requestLayout();
    }
    return insets;
}
```
çŸ¥é“çŠ¶æ€æ ä¸‹é¢çš„èƒŒæ™¯æ€ä¹ˆæ¥çš„äº†å§ã€‚

åˆ°è¿™é‡Œç†é¡ºä¸€ä¸‹æ€è·¯ï¼š
`fitsSystemWindows` ä¸ `onApplyWindowInsets` å…³ç³»ååˆ†å¯†åˆ‡ï¼Œåè€…å°†ç³»ç»Ÿç»™å‡ºçš„ `WindowInsets` æ´¾å‘ç»™ View è®©å…¶æ ¹æ®å‰è€…è¿™ä¸ªå±æ€§æ¥åšè‡ªå·±çš„å¸ƒå±€å’Œç»˜åˆ¶é€»è¾‘ã€‚

#### è¿›é˜¶åº”ç”¨

è¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸‹ `WindowInsets` è¿™ä¸ªç±»ï¼Œå®ƒæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼šconsumeã€‚

è¿™ä¸ªæ¦‚å¿µé‡è¦åˆ°ä»€ä¹ˆç¨‹åº¦å‘¢ï¼Ÿå¦‚æœä½ æä¸æ‡‚ consume å’Œå…¶ immutabilityï¼Œä½ è‡ªå·±çš„å¸ƒå±€æˆ–è€…è‡ªå®šä¹‰ View åŸºæœ¬å°±çˆ†ç‚¸äº†ã€‚

å½“ä¸€ä¸ª `View` çš„ `dispatchApplyWindowInsets` è¢«è°ƒç”¨æ—¶ï¼Œå®ƒéœ€è¦å¯¹ `WindowInsets` å¯¹è±¡ä½œå‡ºå“åº”ï¼Œç„¶åå°†å¤„ç†çš„ç»“æœè¿”å›ï¼Œå¤„ç†ç»“æœåŸºæœ¬å°±ä¸¤ç§ï¼š
1. ä½ æ¶ˆè€—äº†è¿™ä¸ª insetsï¼Œè¿™æ—¶å…¶å®ƒ View æ”¶åˆ°çš„ insets å°±æ˜¯ 0ã€‚
2. ä½ ä¸æƒ³æ¶ˆè€— insetsï¼Œé‚£ä¹ˆå…¶å®ƒ View å°†ç»§ç»­å“åº”ä¸€å¼€å§‹çš„ insets å€¼ã€‚

è¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„æƒ…å†µï¼šä½ è¿”å›äº†æ¶ˆè€—è¿‡çš„ insetsï¼Œä½†ä¿å­˜äº†ä¸€ä»½åŸå§‹ insets å¼•ç”¨ï¼Œè¿™æ—¶è¿™ä¸ªè§†å›¾çš„**å…„å¼Ÿè§†å›¾å’Œå…¶å…„å¼Ÿè§†å›¾çš„å­è§†å›¾**å°±ä¼šæ”¶åˆ°å€¼ä¸º 0 çš„ insetsï¼Œè€Œè¿™ä¸ªè§†å›¾å¯ä»¥æ ¹æ®æƒ…å†µè®©å®ƒçš„å­è§†å›¾æ”¶åˆ°ä¸€ä¸ªåŸå§‹æœªæ¶ˆè€—çš„ insetsï¼Œè¿™ä¹Ÿæ˜¯ `DrawerLayout` æ‰€åšçš„äº‹æƒ…ï¼Œæƒ³ææ¸…å®ƒè¿™ä¹ˆåšçš„åŸå› ï¼Œæœ¬æ–‡å°±è®²ä¸å®Œäº†ï¼Œæˆ‘åæœŸå¯èƒ½ä¼šå†å¼€ä¸€ç¯‡æ–‡ç« åˆ†æã€‚

è®²è¿™ä¹ˆå¤šæœ‰æ²¡æœ‰ ğŸŒ° å‘¢ï¼Ÿå½“ç„¶æœ‰ï¼Œå…ˆçœ‹ä¸‹é¢çš„æ•ˆæœï¼š
<br>
<br>
![Figure 3.](res/android/3.png)
<br>
<br>
æ˜¾ç„¶ï¼Œè¿™æ˜¯ `CoordinatorLayout` é…åˆ `CollapsingToolbarLayout` å®ç°çš„ï¼Œä½†æ˜¯è¿™é‡Œç»™ `CoordinatorLayout` åŠ  `fitsSystemWindows` å°±ä¸çµäº†ï¼Œå®ƒä¼šåƒæ‰çŠ¶æ€æ çš„ä½ç½®ï¼Œç„¶åç”»ä¸ªèƒŒæ™¯è‰²ï¼Œæˆ‘ä»¬çš„å›¾ç‰‡å°±ä¸èƒ½å«åœ¨çŠ¶æ€æ åº•ä¸‹äº†ï¼Œæˆ‘é€šè¿‡åˆ†æå„ä¸ªç±»ï¼ˆè¿™å—çœŸæ˜¯èŠ±äº†å¾ˆå¤šæ—¶é—´ï¼‰ï¼Œå‘ç° `AppBarLayout` ä¹Ÿå®ç°äº† `fitsSystemWindows` çš„è‡ªå®šä¹‰è¡Œä¸ºï¼ˆæ¯•ç«Ÿæ”¾åœ¨å®ƒé‡Œé¢çš„ `CollapsingToolbarLayout` æœ‰ä¸€ä¸ª `statusBarScrim` å±æ€§ï¼‰ï¼Œä½†æ˜¯ç»™å®ƒåŠ ä¸Šè¿™ä¸ªå±æ€§ä»¥åï¼Œå›¾ç‰‡ä¾ç„¶ä¼šè¢«æŒ¤ä¸‹å»ã€‚

æ€ä¹ˆåŠå‘¢ï¼Ÿå°±åœ¨æˆ‘æ‰«è¡ `CollapsingToolbarLayout` çš„æºç çš„æ—¶å€™å‘ç°äº†ä¸‹é¢è¿™æ®µé€»è¾‘ï¼š
```java
@Override
protected void onLayout(boolean changed, int left, int top, int right, int bottom) {
    super.onLayout(changed, left, top, right, bottom);

    if (mLastInsets != null) {
        // Shift down any views which are not set to fit system windows
        final int insetTop = mLastInsets.getSystemWindowInsetTop();
        for (int i = 0, z = getChildCount(); i < z; i++) {
            final View child = getChildAt(i);
            if (!ViewCompat.getFitsSystemWindows(child)) {
                if (child.getTop() < insetTop) {
                    // If the child isn't set to fit system windows but is drawing within
                    // the inset offset it down
                    ViewCompat.offsetTopAndBottom(child, insetTop);
                }
            }
        }
    }

    ...
}
```
è¿™å°±æ˜¯è¯´ï¼Œå¦‚æœ `CollapsingToolbarLayout` çš„æŸä¸ªå­è§†å›¾å¼€å¯äº† `fitsSystemWindows` è¿™ä¸ªå±æ€§ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¢«å¡«æ»¡çˆ¶è§†å›¾ï¼Œå¦åˆ™ï¼Œå®ƒå°±ä¼šè¢«ä¸‹ç§» top inset çš„è·ç¦»ã€‚é‚£è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ³•å°±å¾ˆæ˜æ˜¾äº†ï¼Œç›´æ¥ç»™ `ImageView` åŠ ä¸€ä¸ª `fitsSystemWindows`ï¼Œå®Œäº‹äº†ã€‚

ä¸å¾—ä¸æ„Ÿå¹ Android è®¾è®¡çš„ç²¾å·§ã€‚

åœ¨æˆ‘è¿™ä¹ˆåšä¹‹å‰ï¼Œæˆ‘çœ‹äº†å¸‚é¢ä¸Š 99% çš„ app éƒ½æ˜¯ç”¨äº†å¾ˆâ€œæš´åŠ›â€çš„æ–¹å¼è§£å†³ï¼Œå¼ºè¡Œç®—çŠ¶æ€æ é«˜åº¦ï¼Œç„¶åè®¾ç½® marginï¼Œå¾ˆä¸ä¼˜é›…ï¼Œå®é™…ä¸Š Android å·²ç»ä¸ºæˆ‘ä»¬è€ƒè™‘åœ°ååˆ†å‘¨å…¨äº†ï¼Œå¾ˆå¤šæ•ˆæœåŸºæœ¬éƒ½å¯ä»¥ç”¨åŸç”Ÿçš„æ–¹å¼å®ç°ï¼Œå°±çœ‹ä½ ä¼šä¸ä¼šåšäº†ï¼Œå¦‚ä½•å‘ç°è¿™äº›å°æŠ€å·§ï¼Œè¿˜æ˜¯è¦é æºç åˆ†æã€‚

é‚£ä¹ˆæœ€åç»™å¤§å®¶ç•™ä¸€ä¸ªå°å°çš„ homeworkï¼Œå¯å¦ç»™æˆ‘ä»¬çš„å›¾ç‰‡åœ¨çŠ¶æ€æ çš„ä½ç½®åŠ ä¸€ä¸ª scrimï¼Ÿï¼ˆhintï¼šå¯ä»¥å‚è€ƒ `NavigationView`ï¼‰



#### ç±»çš„åŠ è½½è¿‡ç¨‹
   ![classload](E:\Blog\res\classload.jpg)

-    åŠ è½½ loading
     åŠ è½½é˜¶æ®µä¸»è¦å®Œæˆ[ä¸‰ä»¶](http://www.chinabyte.com/keyword/%E4%B8%89%E4%BB%B6/)äº‹ï¼Œå³é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµï¼Œå°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€[å­˜å‚¨](http://storage.chinabyte.com/)ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼Œåœ¨Javaå †ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨æ­¤ç±»çš„Classå¯¹è±¡ï¼Œä½œä¸ºè®¿é—®æ–¹æ³•åŒºè¿™äº›æ•°æ®çš„å…¥å£ã€‚è¿™ä¸ªåŠ è½½è¿‡ç¨‹ä¸»è¦å°±æ˜¯é ç±»åŠ è½½å™¨å®ç°çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç”±ç”¨æˆ·è‡ªå®šä¹‰ç±»çš„åŠ è½½è¿‡ç¨‹ã€‚

-    éªŒè¯ verification
            è¿™ä¸ªé˜¶æ®µç›®çš„åœ¨äºç¡®ä¿Classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºè¦æ±‚ï¼Œä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«å®‰å…¨ã€‚ä¸»è¦åŒ…æ‹¬å››ç§éªŒè¯ï¼š

-    æ–‡ä»¶æ ¼å¼éªŒè¯ï¼šåŸºäºå­—èŠ‚æµéªŒè¯ï¼ŒéªŒè¯å­—èŠ‚æµæ˜¯å¦ç¬¦åˆClassæ–‡ä»¶æ ¼å¼çš„è§„èŒƒï¼Œå¹¶ä¸”èƒ½è¢«å½“å‰è™šæ‹Ÿæœº
     - å…ƒæ•°æ®éªŒè¯ï¼šåŸºäºæ–¹æ³•åŒºçš„å­˜å‚¨ç»“æ„éªŒè¯ï¼Œå¯¹å­—èŠ‚ç æè¿°ä¿¡æ¯è¿›è¡Œè¯­ä¹‰
     - å­—èŠ‚ç éªŒè¯ï¼šåŸºäºæ–¹æ³•åŒºçš„å­˜å‚¨ç»“æ„éªŒè¯ï¼Œè¿›è¡Œæ•°æ®æµå’Œæ§åˆ¶æµçš„
     - ç¬¦å·å¼•ç”¨éªŒè¯ï¼šåŸºäºæ–¹æ³•åŒºçš„å­˜å‚¨ç»“æ„éªŒè¯ï¼Œå‘ç”Ÿåœ¨è§£æä¸­ï¼Œæ˜¯å¦å¯ä»¥å°†ç¬¦å·å¼•ç”¨æˆåŠŸè§£æä¸ºç›´æ¥å¼•ç”¨ã€‚

-    å‡†å¤‡ preparation
            ä»…ä»…ä¸ºç±»å˜é‡(å³staticä¿®é¥°çš„å­—æ®µå˜é‡)åˆ†é…å†…å­˜å¹¶ä¸”è®¾ç½®è¯¥ç±»å˜é‡çš„åˆå§‹å€¼å³é›¶å€¼ï¼Œè¿™é‡Œä¸åŒ…å«ç”¨finalä¿®é¥°çš„staticï¼Œå› ä¸ºfinalåœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šåˆ†é…äº†ï¼ŒåŒæ—¶è¿™é‡Œä¹Ÿä¸ä¼šä¸ºå®ä¾‹å˜é‡åˆ†é…åˆå§‹åŒ–ã€‚ç±»å˜é‡ä¼šåˆ†é…åœ¨æ–¹æ³•åŒºä¸­ï¼Œè€Œå®ä¾‹å˜é‡æ˜¯ä¼šéšç€å¯¹è±¡ä¸€èµ·åˆ†é…åˆ°Javaå †ä¸­ã€‚

-    è§£æ resolution
            è§£æä¸»è¦å°±æ˜¯å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚ç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°ç›®æ ‡ï¼Œå¯ä»¥æ˜¯ä»»ä½•å­—é¢é‡ï¼Œè€Œç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚æœ‰ç±»æˆ–æ¥å£çš„è§£æï¼Œå­—æ®µè§£æï¼Œç±»æ–¹æ³•è§£æï¼Œ[æ¥å£æ–¹æ³•](http://www.chinabyte.com/keyword/%E6%8E%A5%E5%8F%A3%E6%96%B9%E6%B3%95/)è§£æã€‚

            ã€€ã€€è¿™é‡Œè¦æ³¨æ„å¦‚æœæœ‰ä¸€ä¸ªåŒåå­—æ®µåŒæ—¶å‡ºç°åœ¨ä¸€ä¸ªç±»çš„æ¥å£å’Œçˆ¶ç±»ä¸­ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¸€èˆ¬éƒ½ä¼šæ‹’ç»ç¼–è¯‘ã€‚

-    åˆå§‹åŒ– initialization
            åˆå§‹åŒ–é˜¶æ®µä¾æ—§æ˜¯åˆå§‹åŒ–ç±»å˜é‡å’Œå…¶ä»–èµ„æºï¼Œè¿™é‡Œå°†æ‰§è¡Œç”¨æˆ·çš„staticå­—æ®µå’Œé™æ€è¯­å¥å—çš„èµ‹å€¼æ“ä½œã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ‰§è¡Œç±»æ„é€ å™¨æ–¹æ³•çš„è¿‡ç¨‹ã€‚

            ã€€ã€€æ–¹æ³•æ˜¯ç”±ç¼–è¯‘å™¨æ”¶é›†ç±»ä¸­æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€è¯­å¥å—çš„è¯­å¥ç”Ÿæˆçš„ï¼Œç±»æ„é€ å™¨æ–¹æ³•ä¸å®ä¾‹æ„é€ å™¨æ–¹æ³•ä¸åŒï¼Œè¿™é‡Œé¢ä¸ç”¨æ˜¾ç¤ºçš„è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼Œçˆ¶ç±»çš„æ–¹æ³•ä¼šè‡ªåŠ¨å…ˆæ‰§è¡Œäºå­ç±»çš„æ–¹æ³•ã€‚å³çˆ¶ç±»å®šä¹‰çš„é™æ€è¯­å¥å—å’Œé™æ€å­—æ®µéƒ½è¦ä¼˜å…ˆå­ç±»çš„å˜é‡èµ‹å€¼æ“ä½œã€‚


### androidäº‹ä»¶åˆ†å‘æœºåˆ¶

![viewgroup_touch](E:\Blog\res\viewgroup_touch.png)

| Touch äº‹ä»¶ç›¸å…³æ–¹æ³•                             | æ–¹æ³•åŠŸèƒ½ | ViewGroup | Activity |
| :--------------------------------------- | ---- | --------- | -------- |
| public boolean dispatchTouchEvent(MotionEvent ev) | äº‹ä»¶åˆ†å‘ | Yes       | Yes      |
| public boolean onInterceptTouchEvent(MotionEvent ev) | äº‹ä»¶æ‹¦æˆª | Yes       | No       |
| public boolean onTouchEvent(MotionEvent ev) | äº‹ä»¶å“åº” | Yes       | Yes      |

#### onTouchå’ŒonTouchEventæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œåˆè¯¥å¦‚ä½•ä½¿ç”¨ï¼Ÿ

è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯åœ¨Viewçš„dispatchTouchEventä¸­è°ƒç”¨çš„ï¼ŒonTouchä¼˜å…ˆäºonTouchEventæ‰§è¡Œã€‚å¦‚æœåœ¨onTouchæ–¹æ³•ä¸­é€šè¿‡è¿”å›tureå°†äº‹ä»¶æ¶ˆè´¹æ‰ï¼ŒonTouchEventå°†ä¸å†æ‰§è¡Œã€‚

- androidäº‹ä»¶åˆ†å‘æ˜¯å…ˆä¼ é€’åˆ°ViewGroupï¼Œå†ç”±ViewGroupä¼ é€’åˆ°Viewã€‚
- ViewGroupä¸­å¯ä»¥é€šè¿‡onInterceptTouchEventæ–¹æ³•å¯¹äº‹ä»¶ä¼ é€’è¿›è¡Œæ‹¦æˆªï¼ŒonInterceptTouchæ–¹æ³•è¿”å›trueä»£è¡¨ä¸å…è®¸äº‹ä»¶ç»§ç»­å‘å­Viewä¼ é€’ï¼Œè¿”å›falseä»£è¡¨ä¸å¯¹äº‹ä»¶è¿›è¡Œæ‹¦æˆªï¼Œé»˜è®¤è¿”å›falseã€‚
- å­Viewä¸­å¦‚æœå°†ä¼ é€’çš„äº‹ä»¶æ¶ˆè´¹æ‰ï¼ŒViewGroupä¸­å°†æ— æ³•æ¥æ”¶åˆ°ä»»ä½•äº‹ä»¶ã€‚

#### Touchäº‹ä»¶çš„ä¼ é€’æœºåˆ¶
- æ‰€æœ‰Touchäº‹ä»¶éƒ½è¢«å°è£…æˆMotionEventå¯¹è±¡ï¼ŒåŒ…æ‹¬Touchçš„ä½ç½®ã€æ—¶é—´ã€å†å²è®°å½•ä»¥åŠç¬¬å‡ ä¸ªæ‰‹æŒ‡ï¼ˆå¤šç‚¹è§¦æ§ï¼‰ç­‰ã€‚
- äº‹ä»¶ç±»å‹åˆ†ä¸ºï¼š
  - ACTION_DOWN
  - ACTION_UP
  - ACTION_MOVE
  - ACTION_POINTER_DOWN
  - ACTION_POINTER_UP
  - ACTION_POINTER_CANCEL
- æ¯ä¸ªäº‹ä»¶éƒ½æ˜¯ä»¥ACTION_DOWNå¼€å§‹ï¼Œä»¥ACTION_UPç»“æŸã€‚

1. äº‹ä»¶ä»Activityçš„dispatchTouchEventå¼€å§‹ä¼ é€’ï¼Œåªè¦onInterceptTouchEventä¸è¿›è¡Œæ‹¦æˆªï¼Œä»æœ€ä¸Šå±‚çš„View(ViewGroup)å¼€å§‹ä¸€ç›´å¾€ä¸‹ï¼ˆå­Viewï¼‰ä¼ é€’ã€‚å­Viewå¯ä»¥é€šè¿‡onTouchEventå¯¹äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚
2. å¦‚æœäº‹ä»¶ä»ä¸Šå¾€ä¸‹ä¼ é€’è¿‡ç¨‹ä¸­ä¸€ç›´æ²¡æœ‰è¢«åœæ­¢ï¼Œä¸”æœ€åº•å±‚å­Viewæ²¡æœ‰æ¶ˆè´¹äº‹ä»¶ï¼Œäº‹ä»¶ä¼šåå‘ä¸Šä¼ é€’ï¼Œè¿™æ—¶çˆ¶View(ViewGroup)å¯ä»¥è¿›è¡Œæ¶ˆè´¹ï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰è¢«æ¶ˆè´¹çš„è¯ï¼Œæœ€åä¼šåˆ°Activityçš„onTouchEventã€‚
3. å¦‚æœViewæ²¡æœ‰å¯¹ACTION_DOWNè¿›è¡Œæ¶ˆè´¹ï¼Œä¹‹åçš„å…¶ä»–äº‹ä»¶ä¸ä¼šä¼ é€’è¿‡æ¥ã€‚
4. OnTouchListenerä¼˜å…ˆäºonTouchEventæ‰§è¡Œã€‚

#### Activity Window View ä¸‰è€…çš„å·®åˆ«
Activity æ§åˆ¶å•å…ƒï¼ŒWindow æ‰¿è½½æ¨¡å‹ï¼ŒView æ˜¾ç¤ºè§†å›¾

Activityåœ¨onCreateä¸­è°ƒç”¨attachæ–¹æ³•ï¼Œåœ¨attachæ–¹æ³•ä¸­åˆ›å»ºä¸€ä¸ªwindowå¯¹è±¡ã€‚windowå¯¹è±¡åˆ›å»ºæ—¶å¹¶æ²¡æœ‰åˆ›å»ºDocerViewå¯¹è±¡ï¼Œè€Œæ˜¯å½“ç”¨æˆ·åœ¨Activityä¸­è°ƒç”¨setContentViewæ–¹æ³•ä¹‹åï¼Œæ¥ç€è½¬åˆ°windowçš„setContentViewï¼Œè¿™æ—¶ä¼šæ£€æŸ¥DecorViewæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºDecorViewå¯¹è±¡ï¼Œç„¶åæŠŠç”¨æˆ·è‡ªå·±çš„Viewæ·»åŠ åˆ°DecorViewä¸­ã€‚

#### LayoutInflater
LayoutInflateråªåšä¸€ä»¶äº‹ï¼Œå°±æ˜¯æŠŠxmlè¡¨è¿°çš„layoutè½¬åŒ–ä¸ºViewã€‚

#### LaunchMode åº”ç”¨åœºæ™¯
- standardï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Activity
- singleTopï¼šæ ˆé¡¶ä¸æ˜¯è¯¥ç±»å‹çš„Activityï¼Œåˆ›å»ºä¸€ä¸ªè¡Œçš„Activityã€‚å¦åˆ™ï¼ŒonNewIntentã€‚
- singleTaskï¼šå›é€€æ ˆä¸­æ²¡æœ‰è¯¥ç±»å‹çš„Activityï¼Œåˆ›å»ºActivityï¼Œå¦åˆ™ï¼ŒonNewIntent + ClearTopã€‚
- singleInstanceï¼šå›é€€æ ˆä¸­åªæœ‰è¿™ä¸ªActivityï¼Œæ²¡æœ‰å…¶ä»–Activityã€‚


#### ListViewä¼˜åŒ–
- å¤ç”¨convertViewï¼Œä½¿ç”¨ViewHolder
- itemä¸­æœ‰å›¾ç‰‡æ—¶ï¼Œå¼‚æ­¥åŠ è½½ï¼Œé€‚å½“å¯¹å›¾ç‰‡è¿›è¡Œå‹ç¼©
- ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œæ»‘åŠ¨æ—¶ä¸åŠ è½½å›¾ç‰‡
- å®ç°ä¸Šæ‹‰åŠ è½½æ›´å¤šï¼Œè¿›è¡Œåˆ†é¡µåŠ è½½

#### è‡ªå®šä¹‰Viewçš„åŸºæœ¬æµç¨‹
1. è¦†å†™onDrawã€onMeasureã€onLayout
2. è¦†å†™dispatchTouchEventã€onTouchEvent
3. è¦†å†™è‡ªå®šä¹‰å±æ€§ï¼Œç¼–å†™attr.xmlï¼Œç„¶ååœ¨ä»£ç ä¸­é€šè¿‡TypedArrayç­‰ç±»è·å–è‡ªå®šä¹‰å±æ€§å€¼
4. å¤„ç†æ»‘åŠ¨å†²çªã€åƒç´ è½¬æ¢ç­‰é—®é¢˜
   Other
5. ç¼–å†™attr.xmlæ–‡ä»¶
6. åœ¨layoutå¸ƒå±€æ–‡ä»¶ä¸­å¼•ç”¨ï¼ŒåŒæ—¶å¼•ç”¨å‘½åç©ºé—´
7. åœ¨è‡ªå®šä¹‰æ§ä»¶ä¸­è¿›è¡Œè¯»å–ï¼ˆæ„é€ æ–¹æ³•æ‹¿åˆ°attr.xmlæ–‡ä»¶å€¼ï¼‰
8. è¦†å†™onMeasure
9. è¦†å†™onLayout





# Daily knowledge

1. ä»€ä¹ˆæ˜¯ç±»ï¼Ÿä»€ä¹ˆæ˜¯å¯¹è±¡ï¼Ÿç±»å’Œå¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Ÿ

   > ç±»æ˜¯å¯¹è±¡çš„é›†åˆï¼Œæ˜¯æŠ½è±¡çš„ï¼›å¯¹è±¡æ˜¯ç±»çš„å®ä¾‹åŒ–ï¼Œæ˜¯å…·ä½“çš„ã€‚

2. ç®€è¿°C/C++çš„æ ¸å¿ƒæ€æƒ³

   > http://www.cnblogs.com/lanxuezaipiao/p/4135105.html

3. æ³›å‹çš„æœ¬è´¨

   > æ³›å‹çš„æœ¬è´¨æ˜¯å‚æ•°åŒ–ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æ“ä½œçš„æ•°æ®ç±»å‹è¢«æŒ‡å®šä¸ºæŸä¸ªå‚æ•°ç±»å‹ã€‚
   >
   > è¿™ç§å‚æ•°ç±»å‹å¯ä»¥åœ¨ç±»ã€æ¥å£å’Œæ–¹æ³•ä¸­åˆ›å»ºï¼Œåˆ†åˆ«ç§°ä¸ºæ³›å‹ç±»ã€æ³›å‹æ¥å£ã€æ³›å‹æ–¹æ³•ã€‚
   >
   > ä¼˜ç‚¹ï¼šåœ¨ç¼–è¯‘çš„æ—¶å€™æ£€æŸ¥ç±»å‹å®‰å…¨ï¼Œå¹¶ä¸”ç´ æœ‰çš„å¼ºåˆ¶è½¬æ¢éƒ½æ˜¯è‡ªåŠ¨å’Œéšå¼çš„ï¼Œæé«˜ä»£ç çš„é‡ç”¨ç‡ã€‚
   >
   > ç¼ºç‚¹ï¼š

4. é™æ€å˜é‡çš„ä½¿ç”¨åœºæ™¯

   > 1. å˜é‡æ‰€åŒ…å«çš„å¯¹è±¡æåŠè¾ƒå¤§ï¼Œå ç”¨å†…å­˜è¾ƒå¤šã€‚
   > 2. å˜é‡æ‰€åŒ…å«çš„å¯¹è±¡ç”Ÿåå‘¨æœŸè¾ƒé•¿ã€‚
   > 3. å˜é‡æ‰€åŒ…å«çš„å¯¹è±¡æ•°æ®ç¨³å®šã€‚
   > 4. è¯¥ç±»çš„å¯¹è±¡å®ä¾‹æœ‰å¯¹è¯¥å˜é‡æ‰€åŒ…å«çš„å¯¹è±¡å…±äº«éœ€æ±‚ã€‚

5. ç±»åŠ è½½åŸç†åŠç±»åŠ è½½å™¨

6. å¯¹Cloneçš„ç†è§£

7. HashMapçš„å®ç°

8. Collectionå’ŒCollectionsçš„åŒºåˆ«

9. æ•°ç»„æµ…æ

10. ä»£ç ä¼˜åŒ–ç¼–ç¨‹

11. äº‹ä»¶å¤„ç†æœºåˆ¶ä¸"æ‹çˆ±å…³ç³»"

12. JNDI(Javaå‘½åä¸ç›®å½•æ¥å£)

13. Comparableå’ŒComparatorå®ç°å¯¹è±¡æ¯”è¾ƒ

14. Stringã€StringBufferä¸StringBuilderä¹‹é—´çš„åŒºåˆ«

   > Stringï¼šå­—ç¬¦ä¸²å¸¸é‡
   >
   > StringBufferï¼šå­—ç¬¦ä¸²å˜é‡ï¼Œçº¿ç¨‹å®‰å…¨
   >
   > StringBuilderï¼šå­—ç¬¦ä¸²å˜é‡ï¼Œçº¿ç¨‹éå®‰å…¨
   >
   > ä¸‰è€…åœ¨æ‰§è¡Œé€Ÿåº¦æ–¹é¢çš„æ¯”è¾ƒï¼šStringBuilder > StringBuffer > String
   >
   > **æ€»ç»“**ï¼š
   >
   > 1. æ“ä½œå°‘é‡çš„æ•°æ®ç”¨ String
   > 2. å•çº¿ç¨‹æ“ä½œå­—ç¬¦ä¸²ç¼“å†²åŒºä¸‹æ“ä½œå¤§é‡æ•°æ® StringBuilder
   > 3. å¤šçº¿ç¨‹æ“ä½œå­—ç¬¦ä¸²ç¼“å†²åŒºä¸‹æ“ä½œå¤§é‡æ•°æ® StringBuffer

15. Heapå’ŒStackçš„åŒºåˆ«

16. åå°„æœºåˆ¶



1.  Synchronizedçš„ä½¿ç”¨

    > synchronizedä»£ç å—ï¼š
    >
    > synchronizedæ–¹æ³•ï¼š
    >
    > synchronizedé™æ€æ–¹æ³•ï¼š
    >
    > synchronizedç±»ï¼š
    >
    > synchronized()ï¼š
2.  android:background="?/attr/..."
3.  DrawerLayout
4.  @SuppressLint("...")
5.  @SuppressWarnings("deprecation")
6.  @TargetApi(Build.VERSION_CODES.HONEYCOMB)
7.  CharSequence
8.  attr
9.  dimen
10.  @Nullable
11.  <merge>
12.  android:shadowDx
13.  android:shadowDy
14.  android:shadowRadius
15.  layout_alignWithParentIfMissing







### åŒå‡»è¿”å›é”®é€€å‡º

```java
private long exitTime = 0;

@Override
   public boolean onKeyDown(int keyCode, KeyEvent event) {
       if (keyCode == KeyEvent.KEYCODE_BACK && event.getAction() == KeyEvent.ACTION_DOWN) {
          //ä¸¤ç§’ä¹‹å†…æŒ‰è¿”å›é”®å°±ä¼šé€€å‡º
           if ((System.currentTimeMillis() - exitTime) > 2000) {
               Toast.makeText(getApplicationContext(), "å†æŒ‰ä¸€æ¬¡é€€å‡ºç¨‹åº", Toast.LENGTH_SHORT).show();
               exitTime = System.currentTimeMillis();
           } else {
               finish();
               System.exit(0);
           }
           return true;
       }
       return super.onKeyDown(keyCode, event);
   }
```

